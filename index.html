<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSISM Whiteboard Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f6f6;
      --panel: #ffffff;
      --ink: #222;
      --muted: #666;
      --line: #ddd;
      --accent: #2b7fff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #222; color: #fff; padding: 12px 16px; text-align: center;
    }
    header h1 { margin: 0; font-size: 18px; }
    header p { margin: 4px 0 0; font-size: 12px; color: #bbb; }
    #board {
      display: flex; gap: 12px; padding: 12px; flex: 1;
    }
    #chat {
      flex: 2; background: var(--panel); border: 1px solid var(--line);
      border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
    }
    #messages {
      flex: 1; overflow-y: auto; padding: 10px;
    }
    .msg { margin: 6px 0; }
    .msg .meta { color: var(--muted); font-size: 12px; }
    .msg .text { white-space: pre-wrap; }
    .sys { color: var(--muted); font-style: italic; }
    #inputBar {
      display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--line);
      background: #fafafa;
    }
    #inputBar input, #inputBar button {
      font-size: 14px; padding: 8px 10px;
    }
    #inputBar input { flex: 1; border: 1px solid var(--line); border-radius: 6px; }
    #inputBar button {
      border: 1px solid var(--line); border-radius: 6px; background: #fff; cursor: pointer;
    }
    #sidebar {
      flex: 1; background: var(--panel); border: 1px solid var(--line);
      border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 10px;
    }
    #roomInfo { font-size: 12px; color: var(--muted); }
    #presence { font-size: 12px; color: var(--muted); }
    footer {
      text-align: center; font-size: 12px; padding: 8px; color: var(--muted);
      border-top: 1px solid var(--line); background: #f0f0f0;
    }
    a { color: var(--accent); text-decoration: none; }
    @media (max-width: 800px) {
      #board { flex-direction: column; }
      #sidebar { order: -1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ§  SSISM Whiteboard Chat</h1>
    <p>Type a few lines. Wait. Someone may reply. Or the bot will.</p>
  </header>

  <div id="board">
    <section id="chat" aria-label="Chat panel">
      <div id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div id="inputBar">
        <input id="handle" type="text" placeholder="Your name (optional)" />
        <input id="input" type="text" placeholder="Type your messageâ€¦" />
        <button id="send">Send</button>
      </div>
    </section>

    <aside id="sidebar" aria-label="Room tools">
      <div id="roomInfo"></div>
      <div id="presence">Presence: local mode</div>
      <div>
        <strong>Share this room:</strong>
        <div><input id="shareLink" type="text" readonly style="width:100%; font-size:12px; padding:6px; border:1px solid #ddd; border-radius:6px;" /></div>
      </div>
      <div>
        <strong>Tips:</strong>
        <ul style="margin:6px 0 0 18px; padding:0;">
          <li>Create rooms with ?room=your-room in the URL.</li>
          <li>Set a WebSocket URL in code to go live.</li>
          <li>Bookmark this page to keep your whiteboard handy.</li>
        </ul>
      </div>
    </aside>
  </div>

  <footer>
    SSISM Sentinel â€” Nostalgic Whiteboard (2025)
  </footer>

  <script>
    // â€”â€”â€” Config â€”â€”â€”
    const WS_URL = ""; // e.g., "wss://your-server.example/ws" (leave empty for local mode)
    const BOT_NAME = "Moderator-Bot";
    const BOT_DELAY_MS = 1500;

    // â€”â€”â€” Room from URL â€”â€”â€”
    const params = new URLSearchParams(location.search);
    const room = params.get("room") || "lobby";
    const roomKey = "wb:" + room;
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const handleEl = document.getElementById("handle");
    const sendBtn = document.getElementById("send");
    const roomInfoEl = document.getElementById("roomInfo");
    const presenceEl = document.getElementById("presence");
    const shareLinkEl = document.getElementById("shareLink");

    roomInfoEl.innerHTML = `<strong>Room:</strong> ${room} â€” <span class="sys">(${new Date().toLocaleString()})</span>`;
    shareLinkEl.value = `${location.origin}${location.pathname}?room=${encodeURIComponent(room)}`;

    // â€”â€”â€” State â€”â€”â€”
    let ws;
    let connected = false;
    let lastHumanTs = 0;

    // â€”â€”â€” Utilities â€”â€”â€”
    function storeMessages(list) {
      try { localStorage.setItem(roomKey, JSON.stringify(list)); } catch {}
    }
    function loadMessages() {
      try { return JSON.parse(localStorage.getItem(roomKey) || "[]"); } catch { return []; }
    }
    function appendMessage(sender, text, ts = Date.now()) {
      const time = new Date(ts).toLocaleTimeString();
      const wrap = document.createElement("div");
      wrap.className = "msg";
      wrap.innerHTML = `<div class="meta"><strong>${sender}:</strong> ${time}</div><div class="text">${escapeHTML(text)}</div>`;
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      const data = loadMessages();
      data.push({ sender, text, ts });
      storeMessages(data);
    }
    function appendSystem(text) {
      const p = document.createElement("p");
      p.className = "sys";
      p.textContent = text;
      messagesEl.appendChild(p);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function escapeHTML(s) {
      return s.replace(/[&<>"']/g, c => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c]));
    }

    // â€”â€”â€” Load history â€”â€”â€”
    const history = loadMessages();
    if (history.length === 0) {
      appendSystem("Welcome to the whiteboard. Say hello!");
    } else {
      history.forEach(m => appendMessage(m.sender, m.text, m.ts));
    }

    // â€”â€”â€” Local bot (when alone) â€”â€”â€”
    function scheduleBotIfQuiet() {
      setTimeout(() => {
        const now = Date.now();
        const quiet = now - lastHumanTs > BOT_DELAY_MS;
        if (!connected && quiet) {
          appendMessage(BOT_NAME, "If no oneâ€™s here, Iâ€™ll hold the space. Drop a thought; someone will find it.");
        }
      }, BOT_DELAY_MS);
    }

    // â€”â€”â€” Send â€”â€”â€”
    function sendLocal(sender, text) {
      appendMessage(sender || "You", text);
      lastHumanTs = Date.now();
      scheduleBotIfQuiet();
    }

    function sendWS(sender, text) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return sendLocal(sender, text);
      const payload = JSON.stringify({ room, sender, text, ts: Date.now() });
      ws.send(payload);
    }

    sendBtn.addEventListener("click", () => {
      const text = inputEl.value.trim();
      const sender = handleEl.value.trim() || "Anon";
      if (!text) return;
      inputEl.value = "";
      connected ? sendWS(sender, text) : sendLocal(sender, text);
    });
    inputEl.addEventListener("keydown", e => {
      if (e.key === "Enter") sendBtn.click();
    });

    // â€”â€”â€” WebSocket hookup (optional) â€”â€”â€”
    if (WS_URL) {
      try {
        ws = new WebSocket(WS_URL);
        presenceEl.textContent = "Presence: attempting live connectionâ€¦";
        ws.addEventListener("open", () => {
          connected = true;
          presenceEl.textContent = "Presence: live (multi-user)";
          ws.send(JSON.stringify({ type: "join", room }));
        });
        ws.addEventListener("close", () => {
          connected = false;
          presenceEl.textContent = "Presence: local mode";
        });
        ws.addEventListener("error", () => {
          connected = false;
          presenceEl.textContent = "Presence: local mode (WS error)";
        });
        ws.addEventListener("message", ev => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.room !== room) return;
            appendMessage(msg.sender || "Guest", msg.text || "", msg.ts || Date.now());
          } catch {}
        });
      } catch {
        presenceEl.textContent = "Presence: local mode";
      }
    } else {
      presenceEl.textContent = "Presence: local mode";
      scheduleBotIfQuiet();
    }
  </script>
</body>
</html>

